(()=>{"use strict";const e=(e=1)=>{const t=[];for(let a=0;a<e;a++)t.push(Date.now().toString()+Math.floor(1e3*Math.random()).toString().padStart(3,"0"));return t},t=e=>{let t={};return function e(a){if("object"==typeof a&&null!==a)if(a.children)e(a.children);else for(let s in a)"object"==typeof a[s]&&null!==a[s]?e(a[s]):t[s]=a[s]}(e),t.druidic=e.druidic,t.cant=e.cant,t},a={size:{title:"Размер",configKey:"actorSizes"},di:{title:"Невосприимчивость к урону",configKey:"damageTypes"},dr:{title:"Устойчивость к урону",configKey:"damageTypes"},dv:{title:"Уязвимость к урону",configKey:"damageTypes"},ci:{title:"Невосприимчивость к состоянию",configKey:"conditionTypes"},languages:{title:"Языки",configKey:"languages"},weaponProf:{title:"Умения в оружии",configKey:"weaponTypes"},armorProf:{title:"Умения в броне",configKey:"armorTypes"},toolProf:{title:"Умения в инструментах",configKey:"toolIds"}},s=e=>{function t(e){const t=[];return e.childNodes.forEach((e=>{if(e.nodeType===Node.TEXT_NODE)e.textContent.trim().length>0&&t.push({type:"text",text:e.textContent.trim()});else if(e.nodeType===Node.ELEMENT_NODE){let a=[];"STRONG"===e.tagName&&a.push({type:"bold"}),"EM"===e.tagName&&a.push({type:"italic"}),"SPAN"===e.tagName&&"underline"===e.style.textDecoration&&a.push({type:"underline"}),a.length>0?t.push({type:"text",marks:a,text:`${e.textContent.trim()} `}):t.push({type:"text",text:`${e.textContent.trim()} `})}})),t}const a=(new DOMParser).parseFromString(`<p>${e}</p>`,"text/html").querySelectorAll("p"),s=[];return a.forEach((e=>{e.textContent.trim().length>0&&s.push(function(e){return{type:"paragraph",content:t(e)}}(e))})),s},l=e=>{console.debug("weapon",e);let t=0;const a=e.getAttackToHit();a&&(t=(e=>{const t=e.rollData,a=e.parts;let s=0;return a.forEach((e=>{if("string"==typeof e&&e.startsWith("@")){const a=e.slice(1),l=t[a];void 0!==l&&(s+=parseInt(l,10))}else s+=parseInt(e,10)})),s})(a));const s=e.getDerivedDamageLabel().map((e=>{let t=e.formula,a=e.damageType,s=t.match(/\[(.*?)\]/);if(s){let e=s[1];t=t.replace(`[${e}]`,"")+`[${CONFIG.DND5E.damageTypes[e].label}]`}else t+=`[${CONFIG.DND5E.damageTypes[a].label}]`;return t})).join(" + ");return{bonus:t,damage:s,label:`(атака +${t}, урон ${s})`}},n=e=>{if("spell"===e.type)return e.parent?.system.attributes.spellcasting;const{str:t,dex:a}=e.parent?.system.abilities??{};return e.system.properties.has("fin")&&t&&a?a.mod>t.mod?"dex":"str":{simpleM:"str",martialM:"str",simpleR:"dex",martialR:"dex"}[e.system.type.value]??null},i=t=>({id:`weapon-${e()[0]}`,name:{value:t.name},mod:{value:`+${parseInt(t.system.attack.bonus,10)}`},dmg:{value:t.damage},ability:t.ability?t.ability:n(t),isProf:0!==t.system.prof.multiplier}),o="elfrey-lss-converter",r=e=>({type:"paragraph",content:[{type:"text",text:e}]}),c={acr:{baseStat:"dex",name:"acrobatics",label:"Акробатика",lssSkill:"acrobatics"},ani:{baseStat:"wis",name:"animalHandling",label:"Дрессировка",lssSkill:"animal handling"},arc:{baseStat:"int",name:"arcana",label:"Магия",lssSkill:"arcana"},ath:{baseStat:"str",name:"athletics",label:"Атлетика",lssSkill:"athletics"},dec:{baseStat:"cha",name:"deception",label:"Обман",lssSkill:"deception"},his:{baseStat:"int",name:"history",label:"История",lssSkill:"history"},ins:{baseStat:"wis",name:"insight",label:"Проницательность",lssSkill:"insight"},inv:{baseStat:"int",name:"investigation",label:"Расследование",lssSkill:"investigation"},itm:{baseStat:"cha",name:"intimidation",label:"Запугивание",lssSkill:"intimidation"},med:{baseStat:"wis",name:"medicine",label:"Медицина",lssSkill:"medicine"},nat:{baseStat:"int",name:"nature",label:"Природа",lssSkill:"nature"},per:{baseStat:"cha",name:"persuasion",label:"Убеждение",lssSkill:"persuasion"},prc:{baseStat:"wis",name:"perception",label:"Внимание",lssSkill:"perception"},prf:{baseStat:"cha",name:"performance",label:"Исполнение",lssSkill:"performance"},rel:{baseStat:"int",name:"religion",label:"Религия",lssSkill:"religion"},slt:{baseStat:"dex",name:"sleightOfHand",label:"Ловкость рук",lssSkill:"sleight of hand"},ste:{baseStat:"dex",name:"stealth",label:"Скрытность",lssSkill:"stealth"},sur:{baseStat:"wis",name:"survival",label:"Выживание",lssSkill:"survival"}};Hooks.once("ready",(async function(){game.settings.register(o,"interactive-blocks",{name:"Использовать интерактивные блоки",hint:"При экспорте атаки и способности, которые можно использовать, будут оформлены интерактивными блоками, а не просто текстом",scope:"world",config:!0,type:Boolean,default:!0})})),Hooks.on("getActorDirectoryEntryContext",((n,m)=>{m.push({name:"ELSS.CONVERT",icon:'<i class="fas fa-print"></i>',callback:async([n])=>{var m;const u=n.dataset.documentId,p=null===(m=game.actors)||void 0===m?void 0:m.get(u);if(console.debug("actor",p),p){ui.notifications&&ui.notifications.info(game.i18n.localize("ELSS.CONVERT_START"));(function(e,t){const a=JSON.stringify(e,null,2);saveDataToFile(a,"application/json",`${t}-lss.json`)})(await(async n=>{const m=game.settings.get(o,"interactive-blocks"),u=e(20),p=game.packs.get("dnd5e.items"),{abilities:d,attributes:v,details:b,skills:y,spells:h,currency:f,traits:g,tools:k}=n.system,{items:S}=n;let D={"spells-level-0":{value:{id:`hover-toolbar-spells-level-0-${u[0]}`,data:{type:"doc",content:[]}}}};const N={equipment:{value:{id:`hover-toolbar-equipment-${u[10]}`,data:{type:"doc",content:[]}}}},x={attacks:{value:{id:`hover-toolbar-attacks-${u[12]}`,data:{type:"doc",content:[]}}}},$={traits:{value:{id:`hover-toolbar-traits-${u[12]}`,data:{type:"doc",content:[]}}}},w=({type:e="text",text:t,id:a,textName:s})=>{const l="resource"===e?{type:"resource",attrs:{id:a,textName:s}}:{...t};$.traits.value.data.content.push(l)},E={features:{value:{id:`hover-toolbar-features-${u[13]}`,data:{type:"doc",content:[]}}}},I={items:{value:{id:`hover-toolbar-items-${u[14]}`,data:{type:"doc",content:[]}}}},T={value:{id:`hover-toolbar-prof-${u[11]}`,data:{type:"doc",content:[]}}},O=[],C={},P=[],j=[];let F=[];const G={value:""},K={};let A={};const R={},H={},L={},M={};let z=[];const _={background:{isHidden:!1,value:{id:`hover-toolbar-background-${u[15]}`,data:{type:"doc",content:s(b.biography.value)}}},personality:{value:{id:`hover-toolbar-personality-${u[16]}`,data:{type:"doc",content:s(b.trait)}}},ideals:{value:{id:`hover-toolbar-ideals-${u[17]}`,data:{type:"doc",content:s(b.ideal)}}},bonds:{value:{id:`hover-toolbar-bonds-${u[18]}`,data:{type:"doc",content:s(b.bond)}}},flaws:{value:{id:`hover-toolbar-flaws-${u[19]}`,data:{type:"doc",content:s(b.flaw)}}}};Object.keys(n._classes).forEach((e=>{const t=n._classes[e];"none"!==t.spellcasting.progression&&(j.push(e),F.push(t.name)),K[t.system.hitDice]?K[t.system.hitDice]={current:K[t.system.hitDice].current+t.system.levels,max:K[t.system.hitDice].max+t.system.levels}:K[t.system.hitDice]={current:t.system.levels,max:t.system.levels},""===G.value?G.value=t.system.hitDice:G.value="multiclass",P.push(`${t.name} (${t.system.levels})`)})),Object.keys(h).forEach((e=>{const t=h[e];"pact"===e?0!==t.level&&(A={[`slots-${t.level}`]:{value:t.max}}):(D={...D,[`spells-level-${t.level}`]:{value:{id:`hover-toolbar-spells-level-${t.level}-${u[t.level]}`,data:{type:"doc",content:[]}}}},R[e.replace(/^spell/,"slots-")]={value:t.max,filled:t.max})}));for(let e in d)H[e]={name:e,label:CONFIG.DND5E.abilities[e].label,score:d[e].value,modifier:0,check:0},L[e]={name:e,isProf:!!d[e].proficient};for(let e in y)M[c[e].lssSkill]={baseStat:y[e].ability,name:c[e].lssSkill,label:CONFIG.DND5E.skills[e].label,isProf:y[e].proficient};S.forEach((t=>{switch(t.type){case"spell":if(["rsak","msak"].includes(t.system.actionType)&&0===t.system.level){const e=l(t);O.push(i({...t,...e,parent:n}))}D[`spells-level-${t.system.level}`].value.data.content.push(r(t.name));break;case"equipment":N.equipment.value.data.content.push(r(t.name));break;case"weapon":{const e=l(t);m?O.push(i({...t,...e})):x.attacks.value.data.content.push(r(`${t.name} ${e.label}`));break}case"feat":if(null!==t.system.activation?.type&&t.system.uses.max>0)if(m){const{id:a,item:s}=((t,a="traits")=>{const s=e(),l=["dawn","day","dusk","lr"];let n="";return"sr"===t.system.uses.per?n="short-rest":l.includes(t.system.uses.per)&&(n="long-rest"),{id:`resource-${s}`,item:{id:`resource-${s}`,name:t.name,current:t.system.uses.max,max:t.system.uses.max,location:a,isLongRest:l.includes(t.system.uses.per),isShortRest:"sr"===t.system.uses.per,icon:n}}})(t);C[a]=s,w({type:"resource",id:a,textName:"traits"})}else w({text:r(t.name)});else(({text:e})=>{E.features.value.data.content.push(e)})({text:r(t.name)});break;case"consumable":case"container":case"loot":I.items.value.data.content.push(r(t.name))}}));const q=await(async({pack:e,itemIds:t,weaponProfs:a})=>{let s={};for(let a in t){let l=t[a],n=await e.getDocument(l);n&&(s[a]=n.name)}return{...s,...a}})({pack:p,itemIds:CONFIG.DND5E.weaponIds,weaponProfs:CONFIG.DND5E.weaponProficiencies}),V=await(async({pack:e,itemIds:t,armorProfs:a})=>{let s={};for(let a in t){let l=t[a],n=await e.getDocument(l);n&&(s[a]=n.name)}return{...s,...a}})({pack:p,itemIds:CONFIG.DND5E.armorIds,armorProfs:CONFIG.DND5E.armorProficiencies}),B=await(async({pack:e,itemIds:t,toolsProfs:a})=>{let s={};for(let a in t){let l=t[a],n=await e.getDocument(l);n&&(s[a]=n.name)}return{...s,...a}})({pack:p,itemIds:CONFIG.DND5E.toolIds,toolsProfs:CONFIG.DND5E.vehicleTypes});z=(({traits:e,languages:t,weapons:s,armors:l,tools:n,actorTools:i})=>{let o=[];for(let[r,c]of Object.entries(e)){let e=a[r]?.title||"";if(""!==e){switch(e+=": ",r){case"size":e+=CONFIG.DND5E[a[r].configKey][c].label;break;case"di":case"dr":case"dv":case"dm":case"ci":e+=Array.from(c.value).map((e=>CONFIG.DND5E[a[r].configKey][e].label)).join(", ")+""+(""!==c.custom?`, ${c.custom}`:"");break;case"languages":e+=Array.from(c.value).map((e=>t[e])).join(", ")+""+(""!==c.custom?`, ${c.custom}`:"");break;case"weaponProf":e+=Array.from(c.value).map((e=>s[e])).join(", ")+""+(""!==c.custom?`, ${c.custom}`:"");break;case"armorProf":e+=Array.from(c.value).map((e=>l[e])).join(", ")+""+(""!==c.custom?`, ${c.custom}`:"");break;case"toolProf":{const t=[];for(let e in i)t.push(`${n[e]} ${1!==i[e].value?`(x${i[e].value})`:""}`);e+=t.join(", ");break}}o.push(e)}}return o})({traits:g,languages:t(CONFIG.DND5E.languages),weapons:q,armors:V,tools:B,actorTools:k}),T.value.data.content=z.map((e=>r(e)));const J={isDefault:!0,jsonType:"character",template:"default",name:{value:n.name},info:{charClass:{name:"charClass",label:"класс и уровень",value:P.length>1?P.map((e=>`${e.split(" ")[0].slice(0,4)} (${e.split(" (")[1]}`)).join(" / "):P[0]},level:{name:"level",label:"уровень",value:b.level},background:{name:"background",label:"предыстория",value:b.background?.name||""},playerName:{name:"playerName",label:"имя игрока",value:""},race:{name:"race",label:"раса",value:b.race?.name||""},alignment:{name:"alignment",label:"мировоззрение",value:b.alignment||""},experience:{name:"experience",label:"опыт",value:b.xp.value}},subInfo:{age:{name:"age",label:"возраст",value:b.age||""},height:{name:"height",label:"рост",value:b.height||""},weight:{name:"weight",label:"вес",value:b.weight||""},eyes:{name:"eyes",label:"глаза",value:b.eyes||""},skin:{name:"skin",label:"кожа",value:b.skin||""},hair:{name:"hair",label:"волосы",value:b.hair||""}},spellsInfo:{base:{name:"base",label:"Базовая характеристика заклинаний",value:CONFIG.DND5E.abilities[v.spellcasting]?.label||"Интеллект",code:v.spellcasting},save:{name:"save",label:"Сложность спасброска",value:v.spelldc},mod:{name:"mod",label:"Бонус атаки заклинанием",value:v.spellmod+v.prof},available:{classes:j}},spells:R,spellsPact:A,proficiency:v.prof,stats:H,saves:L,skills:M,vitality:{"hp-dice-current":{value:v.hd},"hit-die":G,"hp-dice-multi":K,ac:{value:v.ac.value},speed:{value:v.movement.walk},initiative:{value:v.init.total},"hp-max":{value:v.hp.max},"hp-current":{value:v.hp.value},"hp-temp":{value:v.hp.temp},isDying:!1,deathFails:0,deathSuccesses:0},text:{prof:T,...N,...D,...x,...$,...I,...E,..._},isHidden:!1,traits:{value:{id:"hover-toolbar-traits",data:{type:"doc",content:[]}}},background:{value:{id:"hover-toolbar-background",data:{type:"doc",content:[]}}},size:9,coins:{cp:{value:f.cp},ep:{value:f.ep},gp:{value:f.gp},pp:{value:f.pp},sp:{value:f.sp}},casterClass:{value:F.join(", ")},weaponsList:O,resources:C};return{tags:[],disabledBlocks:{"info-left":[],"info-right":[],"notes-left":[],"notes-right":[]},spells:{mode:"text",prepared:[],book:[]},data:JSON.stringify(J),jsonType:"character",version:"2"}})(p),null==p?void 0:p.name),ui.notifications&&ui.notifications.info(game.i18n.localize("ELSS.CONVERT_END"))}},condition:e=>{var t;const a=e.data("documentId"),s=null===(t=game.actors)||void 0===t?void 0:t.get(a);return s&&"character"===s.type}})}))})();