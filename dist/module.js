(()=>{"use strict";const e=(e=1)=>{const t=[];for(let a=0;a<e;a++)t.push(Date.now().toString()+Math.floor(1e3*Math.random()).toString().padStart(3,"0"));return t},t=e=>{let t={};return function e(a){if("object"==typeof a&&null!==a)if(a.children)e(a.children);else for(let l in a)"object"==typeof a[l]&&null!==a[l]?e(a[l]):t[l]=a[l]}(e),t.druidic=e.druidic,t.cant=e.cant,t},a={size:{title:"Размер",configKey:"actorSizes"},di:{title:"Невосприимчивость к урону",configKey:"damageTypes"},dr:{title:"Устойчивость к урону",configKey:"damageTypes"},dv:{title:"Уязвимость к урону",configKey:"damageTypes"},ci:{title:"Невосприимчивость к состоянию",configKey:"conditionTypes"},languages:{title:"Языки",configKey:"languages"},weaponProf:{title:"Умения в оружии",configKey:"weaponTypes"},armorProf:{title:"Умения в броне",configKey:"armorTypes"},toolProf:{title:"Умения в инструментах",configKey:"toolIds"}},l=e=>{function t(e){const t=[];return e.childNodes.forEach(e=>{if(e.nodeType===Node.TEXT_NODE)e.textContent.trim().length>0&&t.push({type:"text",text:e.textContent.trim()});else if(e.nodeType===Node.ELEMENT_NODE){let a=[];"STRONG"===e.tagName&&a.push({type:"bold"}),"EM"===e.tagName&&a.push({type:"italic"}),"SPAN"===e.tagName&&"underline"===e.style.textDecoration&&a.push({type:"underline"}),a.length>0?t.push({type:"text",marks:a,text:`${e.textContent.trim()} `}):t.push({type:"text",text:`${e.textContent.trim()} `})}}),t}const a=(new DOMParser).parseFromString(`<p>${e}</p>`,"text/html").querySelectorAll("p"),l=[];return a.forEach(e=>{e.textContent.trim().length>0&&l.push(function(e){return{type:"paragraph",content:t(e)}}(e))}),l},s=e=>{let t=""!==e.labels.toHit?e.labels.toHit:0;const a=function(e){if(!e.system.activities)return[];let t=[];return e.labels.damages.length&&(t=e.labels.damages.map(e=>e.label)),t.join(", ")}(e);if(""!==a)return{bonus:t,damage:a,label:`(атака +${t}, урон ${a})`}},n=e=>{if("spell"===e.type)return e.parent?.system.attributes.spellcasting;const{str:t,dex:a}=e.parent?.system.abilities??{};return e.system.properties.has("fin")&&t&&a?a.mod>t.mod?"dex":"str":{simpleM:"str",martialM:"str",simpleR:"dex",martialR:"dex"}[e.system.type.value]??null},o=t=>({id:`weapon-${e()[0]}`,name:{value:t.name},mod:{value:`+${parseInt(t.bonus,10)}`},dmg:{value:t.damage},ability:t.ability?t.ability:n(t),isProf:0!==t.system.prof.multiplier}),i="elfrey-lss-converter",r=e=>({type:"paragraph",content:[{type:"text",text:e}]}),c={acr:{baseStat:"dex",name:"acrobatics",label:"Акробатика",lssSkill:"acrobatics"},ani:{baseStat:"wis",name:"animalHandling",label:"Дрессировка",lssSkill:"animal handling"},arc:{baseStat:"int",name:"arcana",label:"Магия",lssSkill:"arcana"},ath:{baseStat:"str",name:"athletics",label:"Атлетика",lssSkill:"athletics"},dec:{baseStat:"cha",name:"deception",label:"Обман",lssSkill:"deception"},his:{baseStat:"int",name:"history",label:"История",lssSkill:"history"},ins:{baseStat:"wis",name:"insight",label:"Проницательность",lssSkill:"insight"},inv:{baseStat:"int",name:"investigation",label:"Расследование",lssSkill:"investigation"},itm:{baseStat:"cha",name:"intimidation",label:"Запугивание",lssSkill:"intimidation"},med:{baseStat:"wis",name:"medicine",label:"Медицина",lssSkill:"medicine"},nat:{baseStat:"int",name:"nature",label:"Природа",lssSkill:"nature"},per:{baseStat:"cha",name:"persuasion",label:"Убеждение",lssSkill:"persuasion"},prc:{baseStat:"wis",name:"perception",label:"Внимание",lssSkill:"perception"},prf:{baseStat:"cha",name:"performance",label:"Исполнение",lssSkill:"performance"},rel:{baseStat:"int",name:"religion",label:"Религия",lssSkill:"religion"},slt:{baseStat:"dex",name:"sleightOfHand",label:"Ловкость рук",lssSkill:"sleight of hand"},ste:{baseStat:"dex",name:"stealth",label:"Скрытность",lssSkill:"stealth"},sur:{baseStat:"wis",name:"survival",label:"Выживание",lssSkill:"survival"}};Hooks.once("ready",async function(){game.settings.register(i,"interactive-blocks",{name:"Использовать интерактивные блоки",hint:"При экспорте атаки и способности, которые можно использовать, будут оформлены интерактивными блоками, а не просто текстом",scope:"world",config:!0,type:Boolean,default:!0})}),Hooks.on("getActorContextOptions",(n,u)=>{u.push({name:"ELSS.CONVERT",icon:'<i class="fa-solid fa-print"></i>',callback:async n=>{var u,m,p,d,v;const b=(null===(u=null==n?void 0:n.dataset)||void 0===u?void 0:u.documentId)||(null===(m=null==n?void 0:n.dataset)||void 0===m?void 0:m.entryId),y=null===(p=game.actors)||void 0===p?void 0:p.get(null!=b?b:"");if(y){null===(d=ui.notifications)||void 0===d||d.info(game.i18n.localize("ELSS.CONVERT_START"));(function(e,t){const a=JSON.stringify(e,null,2);saveDataToFile(a,"application/json",`${t}-lss.json`)})(await(async n=>{const u=game.settings.get(i,"interactive-blocks"),m=e(20),p=game.packs?.get?.("dnd5e.items"),{abilities:d,attributes:v,details:b,skills:y,spells:f,currency:h,traits:g,tools:k}=n.system,{items:S}=n;let x={"spells-level-0":{value:{id:`hover-toolbar-spells-level-0-${m[0]}`,data:{type:"doc",content:[]}}}};const N={equipment:{value:{id:`hover-toolbar-equipment-${m[10]}`,data:{type:"doc",content:[]}}}},D={attacks:{value:{id:`hover-toolbar-attacks-${m[12]}`,data:{type:"doc",content:[]}}}},$={traits:{value:{id:`hover-toolbar-traits-${m[12]}`,data:{type:"doc",content:[]}}}},w=({type:e="text",text:t,id:a,textName:l})=>{const s="resource"===e?{type:"resource",attrs:{id:a,textName:l}}:{...t};$.traits.value.data.content.push(s)},E={features:{value:{id:`hover-toolbar-features-${m[13]}`,data:{type:"doc",content:[]}}}},I={items:{value:{id:`hover-toolbar-items-${m[14]}`,data:{type:"doc",content:[]}}}},O={value:{id:`hover-toolbar-prof-${m[11]}`,data:{type:"doc",content:[]}}},T=[],C={},j=[],P=[];let F=[];const G={value:""},K={};let H={};const R={},A={},M={},L={};let z=[];const q={background:{isHidden:!1,value:{id:`hover-toolbar-background-${m[15]}`,data:{type:"doc",content:l(b?.biography?.value||"")}}},personality:{value:{id:`hover-toolbar-personality-${m[16]}`,data:{type:"doc",content:l(b?.trait||"")}}},ideals:{value:{id:`hover-toolbar-ideals-${m[17]}`,data:{type:"doc",content:l(b?.ideal||"")}}},bonds:{value:{id:`hover-toolbar-bonds-${m[18]}`,data:{type:"doc",content:l(b?.bond||"")}}},flaws:{value:{id:`hover-toolbar-flaws-${m[19]}`,data:{type:"doc",content:l(b?.flaw||"")}}}},_=(n.classes??n._classes)||{};let V=0;Object.keys(_).forEach(e=>{const t=_[e];"none"!==(t?.spellcasting?.progression??"none")&&(P.push(e),t?.name&&F.push(t.name));const a=t?.system?.hitDice,l=Number(t?.system?.levels||0);V+=l,a&&(K[a]?K[a]={current:(K[a].current||0)+l,max:(K[a].max||0)+l}:K[a]={current:l,max:l},""===G.value?G.value=a:G.value="multiclass"),t?.name&&j.push(`${t.name} (${l})`)}),Object.keys(f).forEach(e=>{const t=f[e];"pact"===e?0!==t.level&&(H={[`slots-${t.level}`]:{value:t.max}}):(x={...x,[`spells-level-${t.level}`]:{value:{id:`hover-toolbar-spells-level-${t.level}-${m[t.level]}`,data:{type:"doc",content:[]}}}},R[e.replace(/^spell/,"slots-")]={value:t.max,filled:t.max})});for(let e in d)A[e]={name:e,label:CONFIG.DND5E.abilities[e].label,score:d[e].value,modifier:0,check:0},M[e]={name:e,isProf:!!d[e].proficient};for(let e in y){const t=y[e],a=c[e];a&&(L[a.lssSkill]={baseStat:t?.ability,name:a.lssSkill,label:CONFIG.DND5E.skills[e]?.label,isProf:!(!t?.proficient&&!t?.value)})}S.forEach(t=>{switch(t.type){case"spell":if(["rsak","msak"].includes(t.system.actionType)&&0===t.system.level){const e=s(t);T.push(o({...t,...e,parent:n}))}x[`spells-level-${t.system.level}`].value.data.content.push(r(t.name));break;case"equipment":N.equipment.value.data.content.push(r(t.name));break;case"weapon":{const e=s(t);if(null==e)break;u?T.push(o({...t,...e})):D.attacks.value.data.content.push(r(`${t.name} ${e.label}`));break}case"feat":if(null!=t.system.activation?.type&&Number(t.system.uses?.max||0)>0)if(u){const{id:a,item:l}=((t,a="traits")=>{const l=e(),s=["dawn","day","dusk","lr"];let n="";return"sr"===t.system.uses.per?n="short-rest":s.includes(t.system.uses.per)&&(n="long-rest"),{id:`resource-${l}`,item:{id:`resource-${l}`,name:t.name,current:t.system.uses.max,max:t.system.uses.max,location:a,isLongRest:s.includes(t.system.uses.per),isShortRest:"sr"===t.system.uses.per,icon:n}}})(t);C[a]=l,w({type:"resource",id:a,textName:"traits"})}else w({text:r(t.name)});else(({text:e})=>{E.features.value.data.content.push(e)})({text:r(t.name)});break;case"consumable":case"container":case"loot":I.items.value.data.content.push(r(t.name))}});const B=await(async({pack:e,itemIds:t,weaponProfs:a})=>{const l={},s=t&&"object"==typeof t?t:{};if(e&&"function"==typeof e.getDocument)for(const t in s)try{const a=s[t],n=await e.getDocument(a);n&&(l[t]=n.name)}catch(e){}return{...l,...a||{}}})({pack:p,itemIds:CONFIG.DND5E?.weaponIds||{},weaponProfs:CONFIG.DND5E?.weaponProficiencies||{}}),J=await(async({pack:e,itemIds:t,armorProfs:a})=>{const l={},s=t&&"object"==typeof t?t:{};if(e&&"function"==typeof e.getDocument)for(const t in s)try{const a=s[t],n=await e.getDocument(a);n&&(l[t]=n.name)}catch(e){}return{...l,...a||{}}})({pack:p,itemIds:CONFIG.DND5E?.armorIds||{},armorProfs:CONFIG.DND5E?.armorProficiencies||{}}),X=await(async({pack:e,itemIds:t,toolsProfs:a})=>{const l={},s=t&&"object"==typeof t?t:{};if(e&&"function"==typeof e.getDocument)for(const t in s)try{const a=s[t],n=await e.getDocument(a);n&&(l[t]=n.name)}catch(e){}return{...l,...a||{}}})({pack:p,itemIds:CONFIG.DND5E?.toolIds||{},toolsProfs:CONFIG.DND5E?.vehicleTypes||{}});z=(({traits:e,languages:t,weapons:l,armors:s,tools:n,actorTools:o})=>{let i=[];for(let[r,c]of Object.entries(e)){let e=a[r]?.title||"";if(""!==e){switch(e+=": ",r){case"size":e+=CONFIG.DND5E[a[r].configKey][c].label;break;case"di":case"dr":case"dv":case"dm":case"ci":e+=Array.from(c.value).map(e=>CONFIG.DND5E[a[r].configKey][e].label).join(", ")+""+(""!==c.custom?`, ${c.custom}`:"");break;case"languages":e+=Array.from(c.value).map(e=>t[e]).join(", ")+""+(""!==c.custom?`, ${c.custom}`:"");break;case"weaponProf":e+=Array.from(c.value).map(e=>l[e]).join(", ")+""+(""!==c.custom?`, ${c.custom}`:"");break;case"armorProf":e+=Array.from(c.value).map(e=>s[e]).join(", ")+""+(""!==c.custom?`, ${c.custom}`:"");break;case"toolProf":{const t=[];for(let e in o)t.push(`${n[e]} ${1!==o[e].value?`(x${o[e].value})`:""}`);e+=t.join(", ");break}}i.push(e)}}return i})({traits:g,languages:t(CONFIG.DND5E.languages),weapons:B,armors:J,tools:X,actorTools:k}),O.value.data.content=z.map(e=>r(e));const Q={isDefault:!0,jsonType:"character",template:"default",name:{value:n.name},info:{charClass:{name:"charClass",label:"класс и уровень",value:j.length>1?j.map(e=>`${e.split(" ")[0].slice(0,4)} (${e.split(" (")[1]}`).join(" / "):j[0]},level:{name:"level",label:"уровень",value:b?.level??V},background:{name:"background",label:"предыстория",value:b.background?.name||""},playerName:{name:"playerName",label:"имя игрока",value:""},race:{name:"race",label:"раса",value:b.race?.name||""},alignment:{name:"alignment",label:"мировоззрение",value:b.alignment||""},experience:{name:"experience",label:"опыт",value:b.xp.value}},subInfo:{age:{name:"age",label:"возраст",value:b.age||""},height:{name:"height",label:"рост",value:b.height||""},weight:{name:"weight",label:"вес",value:b.weight||""},eyes:{name:"eyes",label:"глаза",value:b.eyes||""},skin:{name:"skin",label:"кожа",value:b.skin||""},hair:{name:"hair",label:"волосы",value:b.hair||""}},spellsInfo:{base:{name:"base",label:"Базовая характеристика заклинаний",value:CONFIG.DND5E.abilities[v.spellcasting]?.label||"Интеллект",code:v.spellcasting},save:{name:"save",label:"Сложность спасброска",value:v.spelldc},mod:{name:"mod",label:"Бонус атаки заклинанием",value:v.spellmod+v.prof},available:{classes:P}},spells:R,spellsPact:H,proficiency:v.prof,stats:A,saves:M,skills:L,vitality:{"hp-dice-current":{value:v.hd},"hit-die":G,"hp-dice-multi":K,ac:{value:v.ac.value},speed:{value:v.movement.walk},initiative:{value:v.init.total},"hp-max":{value:v.hp.max},"hp-current":{value:v.hp.value},"hp-temp":{value:v.hp.temp},isDying:!1,deathFails:0,deathSuccesses:0},text:{prof:O,...N,...x,...D,...$,...I,...E,...q},isHidden:!1,traits:{value:{id:"hover-toolbar-traits",data:{type:"doc",content:[]}}},background:{value:{id:"hover-toolbar-background",data:{type:"doc",content:[]}}},size:9,coins:{cp:{value:h.cp},ep:{value:h.ep},gp:{value:h.gp},pp:{value:h.pp},sp:{value:h.sp}},casterClass:{value:F.join(", ")},weaponsList:T,resources:C};return{tags:[],disabledBlocks:{"info-left":[],"info-right":[],"notes-left":[],"notes-right":[]},spells:{mode:"text",prepared:[],book:[]},data:JSON.stringify(Q),jsonType:"character",version:"2"}})(y),null==y?void 0:y.name),null===(v=ui.notifications)||void 0===v||v.info(game.i18n.localize("ELSS.CONVERT_END"))}},condition:e=>{var t,a,l;const s=e instanceof HTMLElement?e:e&&e[0],n=(null===(t=null==s?void 0:s.dataset)||void 0===t?void 0:t.documentId)||(null===(a=null==s?void 0:s.dataset)||void 0===a?void 0:a.entryId),o=null===(l=game.actors)||void 0===l?void 0:l.get(null!=n?n:"");return!!o&&"character"===o.type}})})})();