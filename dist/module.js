(()=>{"use strict";const e=e=>{let a={};return function e(t){if("object"==typeof t&&null!==t)if(t.children)e(t.children);else for(let l in t)"object"==typeof t[l]&&null!==t[l]?e(t[l]):a[l]=t[l]}(e),a.druidic=e.druidic,a.cant=e.cant,a},a={size:{title:"Размер",configKey:"actorSizes"},di:{title:"Невосприимчивость к урону",configKey:"damageTypes"},dr:{title:"Устойчивость к урону",configKey:"damageTypes"},dv:{title:"Уязвимость к урону",configKey:"damageTypes"},ci:{title:"Невосприимчивость к состоянию",configKey:"conditionTypes"},languages:{title:"Языки",configKey:"languages"},weaponProf:{title:"Умения в оружии",configKey:"weaponTypes"},armorProf:{title:"Умения в броне",configKey:"armorTypes"},toolProf:{title:"Умения в инструментах",configKey:"toolIds"}},t=e=>{function a(e){const a=[];return e.childNodes.forEach((e=>{if(e.nodeType===Node.TEXT_NODE)e.textContent.trim().length>0&&a.push({type:"text",text:e.textContent.trim()});else if(e.nodeType===Node.ELEMENT_NODE){let t=[];"STRONG"===e.tagName&&t.push({type:"bold"}),"EM"===e.tagName&&t.push({type:"italic"}),"SPAN"===e.tagName&&"underline"===e.style.textDecoration&&t.push({type:"underline"}),t.length>0?a.push({type:"text",marks:t,text:`${e.textContent.trim()} `}):a.push({type:"text",text:`${e.textContent.trim()} `})}})),a}const t=(new DOMParser).parseFromString(e,"text/html").querySelectorAll("p"),l=[];return t.forEach((e=>{e.textContent.trim().length>0&&l.push(function(e){return{type:"paragraph",content:a(e)}}(e))})),l},l=e=>({type:"paragraph",content:[{type:"text",text:e}]}),s={acr:{baseStat:"dex",name:"acrobatics",label:"Акробатика",lssSkill:"acrobatics"},ani:{baseStat:"wis",name:"animalHandling",label:"Дрессировка",lssSkill:"animal handling"},arc:{baseStat:"int",name:"arcana",label:"Магия",lssSkill:"arcana"},ath:{baseStat:"str",name:"athletics",label:"Атлетика",lssSkill:"athletics"},dec:{baseStat:"cha",name:"deception",label:"Обман",lssSkill:"deception"},his:{baseStat:"int",name:"history",label:"История",lssSkill:"history"},ins:{baseStat:"wis",name:"insight",label:"Проницательность",lssSkill:"insight"},inv:{baseStat:"int",name:"investigation",label:"Расследование",lssSkill:"investigation"},itm:{baseStat:"cha",name:"intimidation",label:"Запугивание",lssSkill:"intimidation"},med:{baseStat:"wis",name:"medicine",label:"Медицина",lssSkill:"medicine"},nat:{baseStat:"int",name:"nature",label:"Природа",lssSkill:"nature"},per:{baseStat:"cha",name:"persuasion",label:"Убеждение",lssSkill:"persuasion"},prc:{baseStat:"wis",name:"perception",label:"Внимание",lssSkill:"perception"},prf:{baseStat:"cha",name:"performance",label:"Исполнение",lssSkill:"performance"},rel:{baseStat:"int",name:"religion",label:"Религия",lssSkill:"religion"},slt:{baseStat:"dex",name:"sleightOfHand",label:"Ловкость рук",lssSkill:"sleight of hand"},ste:{baseStat:"dex",name:"stealth",label:"Скрытность",lssSkill:"stealth"},sur:{baseStat:"wis",name:"survival",label:"Выживание",lssSkill:"survival"}},n=async n=>{const i=((e=1)=>{const a=[];for(let t=0;t<e;t++)a.push(Date.now().toString()+Math.floor(1e3*Math.random()).toString().padStart(3,"0"));return a})(20),o=game.packs.get("dnd5e.items"),{abilities:r,attributes:c,details:p,skills:m,spells:u,currency:d,traits:v,tools:b}=n.system;let h={"spells-level-0":{value:{id:`hover-toolbar-spells-level-0-${i[0]}`,data:{type:"doc",content:[]}}}};const f={equipment:{value:{id:`hover-toolbar-equipment-${i[10]}`,data:{type:"doc",content:[]}}}},y={attacks:{value:{id:`hover-toolbar-attacks-${i[12]}`,data:{type:"doc",content:[]}}}},g={traits:{value:{id:`hover-toolbar-traits-${i[12]}`,data:{type:"doc",content:[]}}}},k={features:{value:{id:`hover-toolbar-features-${i[13]}`,data:{type:"doc",content:[]}}}},S={items:{value:{id:`hover-toolbar-items-${i[14]}`,data:{type:"doc",content:[]}}}},D={value:{id:`hover-toolbar-prof-${i[11]}`,data:{type:"doc",content:[]}}},N=[],$=[];let w=[];const x={value:""},E={};let I={};const O={},C={},T={},P={};let j=[];const F={background:{isHidden:!1,value:{id:`hover-toolbar-background-${i[15]}`,data:{type:"doc",content:t(p.biography.value)}}},personality:{value:{id:`hover-toolbar-personality-${i[16]}`,data:{type:"doc",content:t(p.trait)}}},ideals:{value:{id:`hover-toolbar-ideals-${i[17]}`,data:{type:"doc",content:t(p.ideal)}}},bonds:{value:{id:`hover-toolbar-bonds-${i[18]}`,data:{type:"doc",content:t(p.bond)}}},flaws:{value:{id:`hover-toolbar-flaws-${i[19]}`,data:{type:"doc",content:t(p.flaw)}}}};Object.keys(n._classes).forEach((e=>{const a=n._classes[e];"none"!==a.spellcasting.progression&&($.push(e),w.push(a.name)),E[a.system.hitDice]?E[a.system.hitDice]={current:E[a.system.hitDice].current+a.system.levels,max:E[a.system.hitDice].max+a.system.levels}:E[a.system.hitDice]={current:a.system.levels,max:a.system.levels},""===x.value?x.value=a.system.hitDice:x.value="multiclass",N.push(`${a.name} (${a.system.levels})`)})),Object.keys(u).forEach((e=>{const a=u[e];"pact"===e?0!==a.level&&(I={[`slots-${a.level}`]:{value:a.max}}):(h={...h,[`spells-level-${a.level}`]:{value:{id:`hover-toolbar-spells-level-${a.level}-${i[a.level]}`,data:{type:"doc",content:[]}}}},O[e.replace(/^spell/,"slots-")]={value:a.max,filled:a.max})}));for(let e in r)C[e]={name:e,label:CONFIG.DND5E.abilities[e].label,score:r[e].value,modifier:0,check:0},T[e]={name:e,isProf:!!r[e].proficient};for(let e in m)P[s[e].lssSkill]={baseStat:m[e].ability,name:s[e].lssSkill,label:CONFIG.DND5E.skills[e].label,isProf:m[e].proficient};n.items.forEach((e=>{switch(e.type){case"spell":h[`spells-level-${e.system.level}`].value.data.content.push(l(e.name));break;case"equipment":f.equipment.value.data.content.push(l(e.name));break;case"weapon":{const t=`(атака +${function(e){const a=e.rollData,t=e.parts;let l=0;return t.forEach((e=>{if(e.startsWith("@")){const t=e.slice(1),s=a[t];void 0!==s&&(l+=parseInt(s,10))}else l+=parseInt(e,10)})),l}((a=e).getAttackToHit())}, урон ${a.getDerivedDamageLabel().map((({label:e})=>e)).join(", ")})`;y.attacks.value.data.content.push(l(`${e.name} ${t}`));break}case"feat":null!==e.system.activation?.type?g.traits.value.data.content.push(l(e.name)):k.features.value.data.content.push(l(e.name));break;case"consumable":case"container":case"loot":S.items.value.data.content.push(l(e.name))}var a}));const G=await(async({pack:e,itemIds:a,weaponProfs:t})=>{let l={};for(let t in a){let s=a[t],n=await e.getDocument(s);n&&(l[t]=n.name)}return{...l,...t}})({pack:o,itemIds:CONFIG.DND5E.weaponIds,weaponProfs:CONFIG.DND5E.weaponProficiencies}),K=await(async({pack:e,itemIds:a,armorProfs:t})=>{let l={};for(let t in a){let s=a[t],n=await e.getDocument(s);n&&(l[t]=n.name)}return{...l,...t}})({pack:o,itemIds:CONFIG.DND5E.armorIds,armorProfs:CONFIG.DND5E.armorProficiencies}),A=await(async({pack:e,itemIds:a,toolsProfs:t})=>{let l={};for(let t in a){let s=a[t],n=await e.getDocument(s);n&&(l[t]=n.name)}return{...l,...t}})({pack:o,itemIds:CONFIG.DND5E.toolIds,toolsProfs:CONFIG.DND5E.vehicleTypes});j=(({traits:e,languages:t,weapons:l,armors:s,tools:n,actorTools:i})=>{let o=[];for(let[r,c]of Object.entries(e)){let e=a[r]?.title||"";if(""!==e){switch(e+=": ",r){case"size":e+=CONFIG.DND5E[a[r].configKey][c];break;case"di":case"dr":case"dv":case"dm":case"ci":e+=Array.from(c.value).map((e=>CONFIG.DND5E[a[r].configKey][e].label)).join(", ")+""+(""!==c.custom?`, ${c.custom}`:"");break;case"languages":e+=Array.from(c.value).map((e=>t[e])).join(", ")+""+(""!==c.custom?`, ${c.custom}`:"");break;case"weaponProf":e+=Array.from(c.value).map((e=>l[e])).join(", ")+""+(""!==c.custom?`, ${c.custom}`:"");break;case"armorProf":e+=Array.from(c.value).map((e=>s[e])).join(", ")+""+(""!==c.custom?`, ${c.custom}`:"");break;case"toolProf":{const a=[];for(let e in i)a.push(`${n[e]} ${1!==i[e].value?`(x${i[e].value})`:""}`);e+=a.join(", ");break}}o.push(e)}}return o})({traits:v,languages:e(CONFIG.DND5E.languages),weapons:G,armors:K,tools:A,actorTools:b}),D.value.data.content=j.map((e=>l(e)));const H={isDefault:!0,jsonType:"character",template:"default",name:{value:n.name},info:{charClass:{name:"charClass",label:"класс и уровень",value:N.length>1?N.map((e=>`${e.split(" ")[0].slice(0,4)} (${e.split(" (")[1]}`)).join(" / "):N[0]},level:{name:"level",label:"уровень",value:p.level},background:{name:"background",label:"предыстория",value:p.background.name},playerName:{name:"playerName",label:"имя игрока",value:""},race:{name:"race",label:"раса",value:p.race.name},alignment:{name:"alignment",label:"мировоззрение",value:p.alignment},experience:{name:"experience",label:"опыт",value:p.xp.value}},subInfo:{age:{name:"age",label:"возраст",value:p.age},height:{name:"height",label:"рост",value:p.height},weight:{name:"weight",label:"вес",value:p.weight},eyes:{name:"eyes",label:"глаза",value:p.eyes},skin:{name:"skin",label:"кожа",value:p.skin},hair:{name:"hair",label:"волосы",value:p.hair}},spellsInfo:{base:{name:"base",label:"Базовая характеристика заклинаний",value:CONFIG.DND5E.abilities[c.spellcasting].label,code:c.spellcasting},save:{name:"save",label:"Сложность спасброска",value:c.spelldc},mod:{name:"mod",label:"Бонус атаки заклинанием",value:c.spellmod+c.prof},available:{classes:$}},spells:O,spellsPact:I,proficiency:c.prof,stats:C,saves:T,skills:P,vitality:{"hp-dice-current":{value:c.hd},"hit-die":x,"hp-dice-multi":E,ac:{value:c.ac.value},speed:{value:c.movement.walk},initiative:{value:c.init.total},"hp-max":{value:c.hp.max},"hp-current":{value:c.hp.value},"hp-temp":{value:c.hp.temp},isDying:!1,deathFails:0,deathSuccesses:0},text:{prof:D,...f,...h,...y,...g,...S,...k,...F},isHidden:!1,traits:{value:{id:"hover-toolbar-traits",data:{type:"doc",content:[]}}},background:{value:{id:"hover-toolbar-background",data:{type:"doc",content:[]}}},size:9,coins:{cp:{value:d.cp},ep:{value:d.ep},gp:{value:d.gp},pp:{value:d.pp},sp:{value:d.sp}},casterClass:{value:w.join(", ")}};return{tags:[],disabledBlocks:{"info-left":[],"info-right":[],"notes-left":[],"notes-right":[]},spells:{mode:"text",prepared:[],book:[]},data:JSON.stringify(H),jsonType:"character",version:"2"}};Hooks.on("getActorDirectoryEntryContext",((e,a)=>{a.push({name:"ELSS.CONVERT",icon:'<i class="fas fa-print"></i>',callback:async([e])=>{var a;const t=e.dataset.documentId,l=null===(a=game.actors)||void 0===a?void 0:a.get(t);if(l){!function(e,a){const t=JSON.stringify(e,null,2);saveDataToFile(t,"application/json",`${a}-lss.json`)}(await n(l),null==l?void 0:l.name)}}})}))})();